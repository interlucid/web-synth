<link rel="import" href="../bower_scripts/polymer/polymer-element.html">

<dom-module id="keyboard-control">

  <template>

    <style>

        :host {
            display: block;
            padding: 2em;
        }

        .white-key {
            fill:#fff;
            stroke-width:1px;
            stroke:#000;
        }

        .black-key {
            stroke-width:1px;
            stroke:#000;
        }

        .horizontal-container {
            display: flex;
        }

        .horizontal-container > * + * {
            margin-left: 2em;
        }

        .sliders {
            min-width: 30%;
        }

        .sliders label {
            display: flex;
            justify-content: space-between;
        }

        .sliders label > * {
            flex-basis: 50%;
        }

        input {
            -webkit-appearance: none;
            background: transparent;
            border: solid #BBB .05em;
            border-radius: .3em;
            padding: .5em;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 2em;
            width: 2em;
            border-radius: 5em;
            margin-top: -.7em;
            background: #333;
        }

        input[type=range]::-moz-range-thumb {
            height: 2em;
            width: 2em;
            border-radius: 5em;
            margin-top: -.7em;
            background: #333;
        }

        input[type=range]::-webkit-slider-runnable-track {
            height: .5em;
            margin: .7em .3em;
            border-radius: 5em;
            background: #ee8224;
        }

        input[type=range]::-moz-range-track {
            height: .5em;
            width: 100%;
            margin: .7em .3em;
            border-radius: 5em;
            background: #ee8224;
        }

        button {
            border: solid #bbb .05em;
            border-radius: .3em;
            padding: .5em;
            cursor: pointer;
        }

        button:hover {
            background-color: #ee8224;
            color: white;
        }

    </style>

    <h1>OLD</h1>

    <div on-mouseup="stopPlaying" on-mouseleave="stopPlaying" on-keydown="playNoteWithKeyboard" on-keyup="stopPlayingWithKeyboard">
        <svg xmlns="http://www.w3.org/2000/svg" width="600" height="300" viewBox="0 0 800 500" stroke-linejoin="round">
            <path class="white-key" on-mouseover="playNoteWithMouse" on-mousedown="playNoteWithMouse" note="c" d="M119.9 46.3c0-5.4-4.4-9.8-9.8-9.8l-65.7 0c-5.4 0-9.8 4.4-9.8 9.8l0 409.8c0 5.4 4.4 9.8 9.8 9.8l65.7 0c5.4 0 9.8-4.4 9.8-9.8l0-409.8Z"/>
            <path class="white-key" on-mouseover="playNoteWithMouse" on-mousedown="playNoteWithMouse" note="d" d="M205 46.3c0-5.4-4.4-9.8-9.8-9.8l-65.7 0c-5.4 0-9.8 4.4-9.8 9.8l0 409.8c0 5.4 4.4 9.8 9.8 9.8l65.7 0c5.4 0 9.8-4.4 9.8-9.8l0-409.8Z"/>
            <path class="white-key" on-mouseover="playNoteWithMouse" on-mousedown="playNoteWithMouse" note="e" d="M290.3 46.3c0-5.4-4.4-9.8-9.8-9.8l-65.7 0c-5.4 0-9.8 4.4-9.8 9.8l0 409.8c0 5.4 4.4 9.8 9.8 9.8l65.7 0c5.4 0 9.8-4.4 9.8-9.8l0-409.8Z"/>
            <path class="white-key" on-mouseover="playNoteWithMouse" on-mousedown="playNoteWithMouse" note="f" d="M375.5 46.3c0-5.4-4.4-9.8-9.8-9.8l-65.7 0c-5.4 0-9.8 4.4-9.8 9.8l0 409.8c0 5.4 4.4 9.8 9.8 9.8l65.7 0c5.4 0 9.8-4.4 9.8-9.8l0-409.8Z"/>
            <path class="white-key" on-mouseover="playNoteWithMouse" on-mousedown="playNoteWithMouse" note="g" d="M460.6 46.3c0-5.4-4.4-9.8-9.8-9.8l-65.7 0c-5.4 0-9.8 4.4-9.8 9.8l0 409.8c0 5.4 4.4 9.8 9.8 9.8l65.7 0c5.4 0 9.8-4.4 9.8-9.8l0-409.8Z"/>
            <path class="white-key" on-mouseover="playNoteWithMouse" on-mousedown="playNoteWithMouse" note="a" d="M545.9 46.3c0-5.4-4.4-9.8-9.8-9.8l-65.7 0c-5.4 0-9.8 4.4-9.8 9.8l0 409.8c0 5.4 4.4 9.8 9.8 9.8l65.7 0c5.4 0 9.8-4.4 9.8-9.8l0-409.8Z"/>
            <path class="white-key" on-mouseover="playNoteWithMouse" on-mousedown="playNoteWithMouse" note="b" d="M631 46.3c0-5.4-4.4-9.8-9.8-9.8l-65.7 0c-5.4 0-9.8 4.4-9.8 9.8l0 409.8c0 5.4 4.4 9.8 9.8 9.8l65.7 0c5.4 0 9.8-4.4 9.8-9.8l0-409.8Z"/>
            <path class="white-key" on-mouseover="playNoteWithMouse" on-mousedown="playNoteWithMouse" note="c2" d="M716.4 46.3c0-5.4-4.4-9.8-9.8-9.8l-65.7 0c-5.4 0-9.8 4.4-9.8 9.8l0 409.8c0 5.4 4.4 9.8 9.8 9.8l65.7 0c5.4 0 9.8-4.4 9.8-9.8l0-409.8Z"/>
            <path class="black-key" on-mouseover="playNoteWithMouse" on-mousedown="playNoteWithMouse" note="c#" d="M146 42.6c0-3.3-2.7-6-6-6l-40.6 0c-3.3 0-6 2.7-6 6l0 258.1c0 3.3 2.7 6 6 6l40.6 0c3.3 0 6-2.7 6-6l0-258.1Z"/>
            <path class="black-key" on-mouseover="playNoteWithMouse" on-mousedown="playNoteWithMouse" note="d#" d="M231.8 42.6c0-3.3-2.7-6-6-6l-40.6 0c-3.3 0-6 2.7-6 6l0 258.1c0 3.3 2.7 6 6 6l40.6 0c3.3 0 6-2.7 6-6l0-258.1Z"/>
            <path class="black-key" on-mouseover="playNoteWithMouse" on-mousedown="playNoteWithMouse" note="f#" d="M401 42.6c0-3.3-2.7-6-6-6l-40.6 0c-3.3 0-6 2.7-6 6l0 258.1c0 3.3 2.7 6 6 6l40.6 0c3.3 0 6-2.7 6-6l0-258.1Z"/>
            <path class="black-key" on-mouseover="playNoteWithMouse" on-mousedown="playNoteWithMouse" note="g#" d="M488 42.5c0-3.3-2.7-6-6-6l-40.6 0c-3.3 0-6 2.7-6 6l0 258.1c0 3.3 2.7 6 6 6l40.6 0c3.3 0 6-2.7 6-6l0-258.1Z"/>
            <path class="black-key" on-mouseover="playNoteWithMouse" on-mousedown="playNoteWithMouse" note="a#" d="M573 42.5c0-3.3-2.7-6-6-6l-40.6 0c-3.3 0-6 2.7-6 6l0 258.1c0 3.3 2.7 6 6 6l40.6 0c3.3 0 6-2.7 6-6l0-258.1Z"/>
        </svg>
        
        <div class="horizontal-container">
            <div id="amplitude-envelope" class="sliders">
                <h2>Amplitude Envelope</h2>
                <label><span>Attack: [[configuration.attack]] s</span> <input type="range" min="0.03" max="2" step="0.001" value="{{configuration.attack::input}}"></label>
                <label><span>Sustain: [[configuration.sustain]]</span> <input type="range" min="0.03" max="1" step="0.01" value="{{configuration.sustain::input}}"></label>
                <label><span>Decay: [[configuration.decay]] s</span> <input type="range" min="0.03" max="2" step="0.001" value="{{configuration.decay::input}}"></label>
                <label><span>Release: [[configuration.release]] s</span> <input type="range" min="0.03" max="2" step="0.001" value="{{configuration.release::input}}"></label>
            </div>
            <div id="oscillator-type">
                <h2>Type: [[oscillatorNode.type]]</h2>
                <button on-click="changeOscillator" oscillator="sine">Sine</button>
                <button on-click="changeOscillator" oscillator="square">Square</button>
                <button on-click="changeOscillator" oscillator="sawtooth">Sawtooth</button>
                <button on-click="changeOscillator" oscillator="triangle">Triangle</button>
            </div>
            <div id="filter" class="sliders">
                <h2>Filter</h2>
                <label><span>Frequency: [[calcFrequency(configuration.filter.frequencyLog)]] Hz</span> <input type="range" min="33" max="140" value="{{configuration.filter.frequencyLog::input}}"></label>
            </div>
        </div>
        <p>Tip: Filter works best with sawtooth oscillators.</p>
        <div class="horizontal-container">
            <div id="save-to-database">
                <h2>Save to database</h2>
                <label>Name: <input type="text" value="{{saveName::input}}"></label>
                <button on-click="saveToDatabase">Save</button>
            </div>
            <div id="load-from-database">
                <h2>Load from database</h2>
                <label>Name: <input type="text" value="{{loadName::input}}"></label>
                <button on-click="loadFromDatabase">Load</button>
            </div>
        </div>
    </div>
    
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class KeyboardControl extends Polymer.Element {

        static get is() { return 'keyboard-control'; }

        static get properties() {
            return {
                configuration: {
                    type: Object,
                    value: {
                        attack: 0.1,
                        sustain: 0.8,
                        decay: 0.3,
                        release: 0.7,
                        filter: {
                            frequencyLog: 84
                        }
                    }
                },
                context: {
                    type: Object
                },
                oscillatorNode: {
                    type: Object
                },
                biquadFilterNode: {
                    type: Object
                },
                saveName: {
                    type: String,
                    value: ''
                },
                loadName: {
                    type: String,
                    value: ''
                }
            };
        }

        static get observers() {
            return [
                'changeFilterFrequency(configuration.filter.frequencyLog)'
            ]
        }

        connectedCallback() {
            super.connectedCallback();
            // set up this.context and oscillator
            this.context = new (window.AudioContext || window.webkitAudioContext)();
            this.oscillatorNode = this.context.createOscillator();
            this.gainNode = this.context.createGain();
            this.biquadFilterNode = this.context.createBiquadFilter();
            this.oscillatorNode.connect(this.biquadFilterNode);
            this.biquadFilterNode.connect(this.gainNode);
            this.gainNode.connect(this.context.destination);
            // start at a very low volume to simulate no sound (and eliminate pop)
            this.gainNode.gain.exponentialRampToValueAtTime(0.0001, this.context.currentTime);
            this.oscillatorNode.start();
            window.addEventListener('keydown', (e) => {
                this.playNoteWithKeyboard(e);
            })
            window.addEventListener('keyup', (e) => {
                this.stopPlayingWithKeyboard(e);
            })
        }

        playNoteWithMouse(e, note) {
            // only play if the left mouse button is down
            if(e.buttons === 1) this.playNote(e.target.getAttribute('note'));
        }

        playNoteWithKeyboard(e) {
            let note;
            if(keys[e.key] && !keys[e.key].pressed) {
                // set the key to be pressed
                keys[e.key].pressed = true;
                // get the appropriate note
                note = keys[e.key].note;
            }
            // only play a note if it is defined
            if(note) this.playNote(note);
        }

        playNote(note) {
            this.oscillatorNode.frequency.exponentialRampToValueAtTime(noteFrequencies[note], this.context.currentTime + 0.03)
            // cancel previous ramp
            this.gainNode.gain.cancelAndHoldAtTime(this.context.currentTime);
            // reset gain to 0
            this.gainNode.gain.exponentialRampToValueAtTime(0.0001, this.context.currentTime + 0.03);
            // ramp up for attack amount of time
            this.gainNode.gain.exponentialRampToValueAtTime(1, this.context.currentTime + parseFloat(this.configuration.attack));
            // gainNode.gain.setValueAtTime(1, this.context.currentTime + this.configuration.attack);
            // ramp down to sustain level for decay amount of time
            this.gainNode.gain.exponentialRampToValueAtTime(this.configuration.sustain, parseFloat(this.context.currentTime) + parseFloat(this.configuration.decay));
        }
        

        stopPlayingWithKeyboard(e) {
            if(keys[e.key]) {
                // clear the key press
                keys[e.key].pressed = false;
                // if all the keys are pressed, stop playing
                if(this.areAllKeysPressed()) this.stopPlaying();
            }
        }

        stopPlaying() {
            this.gainNode.gain.cancelAndHoldAtTime(this.context.currentTime);
            // ramp down for release amount of time
            this.gainNode.gain.exponentialRampToValueAtTime(0.0001, this.context.currentTime + parseFloat(this.configuration.release));
        }

        areAllKeysPressed() {
            return !Object.values(keys).map(key => key.pressed).reduce((acc, cur) => acc || cur);
        };

        changeOscillator(e) {
            this.set('oscillatorNode.type', e.target.getAttribute('oscillator'));
        }

        changeFilterFrequency(frequencyLog) {
            if(!this.biquadFilterNode) return;
            this.biquadFilterNode.frequency.setValueAtTime(Math.pow(2, frequencyLog / 10), this.context.currentTime);
        }

        calcFrequency(frequencyLog) {
            return Math.pow(2, frequencyLog / 10).toFixed(0);
        }

        saveToDatabase() {
            fetch('/api/patches', {
                method: 'POST',
                body: JSON.stringify({
                    name: this.saveName,
                    configuration: {
                        ...this.configuration,
                        type: this.oscillatorNode.type
                    }
                }),
                headers: new Headers({
                    'Content-Type': 'application/json'
                })
            });
        }

        async loadFromDatabase() {
            fetch(`/api/patches/${this.loadName}`)
                .then(async response => {
                    const result = await response.json()
                    this.set('configuration', result.configuration);
                    this.set('oscillatorNode.type', result.configuration.type);
                });
        }

    }

    window.customElements.define(KeyboardControl.is, KeyboardControl);
  </script>
</dom-module>
